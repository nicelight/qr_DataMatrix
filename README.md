# Система контроля доступа на WT32-ETH01 (DataMatrix)

## Описание

Этот проект предназначен для работы с контроллером WT32-ETH01 и реализует две основные функции:
- **Режим "Сервер"** — устройство работает как веб-сервер, принимает запросы, ведёт базу DM-кодов.
- **Режим "Клиент"** — устройство работает как клиент, получает DataMatrix-код по UART и отправляет его на внешний сервер через HTTP.

Выбор режима осуществляется через настройки в файле `platformio.ini`.

---

## Аппаратные требования

- WT32-ETH01 (ESP32 с Ethernet)
- Сканер DataMatrix, подключённый к UART (RX/TX)
- Электромеханический замок/реле/турникет, подключённый к пину управления
- Светодиод для индикации (опционально)

---

## Установка и настройка

### 1. Клонируйте репозиторий

```sh
git clone https://github.com/yourname/yourproject.git
cd yourproject
```

### 2. Установите [PlatformIO](https://platformio.org/) (если ещё не установлен)

- Для VSCode: установите расширение PlatformIO IDE.
- Или через pip:  
  ```sh
  pip install platformio
  ```

### 3. Настройте параметры сети

Откройте файл `src/nastroyki.h` и укажите:
- IP-адрес устройства (модуля)
- IP-адрес шлюза (роутера)
- IP-адрес сервера (для режима "Клиент")

Пример:
```cpp
#define IP_OCT1 192
#define IP_OCT2 168
#define IP_OCT3 50
#define IP_OCT4 231
#define IP_GATE 1

#define SERVER_OCT1 192
#define SERVER_OCT2 168
#define SERVER_OCT3 50
#define SERVER_OCT4 100
```

---

## Выбор режима работы

В проекте реализовано два режима:

### 1. Клиент (отправка DM-кода на сервер)

- Основной файл: `main_as_a_client_v0.2.cpp`
- Для выбора этого режима ничего менять не нужно — он выбран по умолчанию.

### 2. Сервер (приём DM-кодов, работа с базой)

- Основной файл: `main_as_a_server_v0.1_stable.cpp`
- Чтобы выбрать этот режим, откройте `platformio.ini` и раскомментируйте нужную строку `build_src_filter`, закомментировав другую.

#### Пример для клиента:
```ini
build_src_filter = +<main_as_a_client_v0.2.cpp> +<nastroyki.h> +<led.h> +<timer.h> +<sets.h> +<sets.cpp>
```

#### Пример для сервера:
```ini
build_src_filter = +<main_as_a_server_v0.1_stable.cpp> +<nastroyki.h> +<led.h> +<timer.h> +<sets.h> +<sets.cpp>
```

---

## Сборка и прошивка

1. Подключите WT32-ETH01 к компьютеру через USB-UART.
2. В терминале выполните:
   ```sh
   pio run -t upload
   ```
   или используйте кнопку "Upload" в PlatformIO IDE.

---

## Как это работает

### Режим "Клиент"

- Сканер DataMatrix передаёт код по UART.
- Модуль извлекает числовой идентификатор из кода.
- Формируется JSON вида:
  ```json
  {
    "passIds": ["1000000000"],
    "code": "TURNIKET"
  }
  ```
- JSON отправляется POST-запросом на сервер.
- Если сервер отвечает 200 — открывается дверь на 2 секунды.
- Если ошибка или таймаут — мигает светодиод.

### Режим "Сервер"

- Модуль работает как веб-сервер.
- Принимает запросы, ведёт базу DM-кодов, управляет доступом.

---

## Важные файлы

- `main_as_a_client_v0.2.cpp` — код клиента
- `main_as_a_server_v0.1_stable.cpp` — код сервера
- `nastroyki.h` — все основные настройки (IP, пины и т.д.)
- `platformio.ini` — конфигурация сборки и выбора режима

---

## Советы

- Если при сборке появляется предупреждение о `src_filter`, замените его на `build_src_filter` (уже сделано в этом проекте).
- Для смены режима не нужно переименовывать файлы — просто меняйте строку `build_src_filter` в `platformio.ini`.
- Для отладки используйте монитор порта:
  ```sh
  pio device monitor
  ```

---

## Вопросы и поддержка

Если возникли вопросы — создайте issue на GitHub или напишите автору проекта.

---

Удачи в работе с проектом!
