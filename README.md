# Сквозная автоматизированная система контроля доступа в заведения по QR кодам

## Описание
В заведение устанавливается 1С бухгалтерия с подключенным сканером qr кодов. При сканировании очередного кода на браслете, 1С отправляет его на сервер в базу данных. Теперь посетитель может надеть браслет на руку, просканировать этот qr код на входе. Турникет, считав код, отправляет запрос на сервер, и если код есть в базе и доступ разрешен, турникет открывает дверь, отправляя сигнал, что клиент вошел вовнутрь.


### Пример работы системы
1. Посетитель подносит браслет/код к сканеру.
2. Турникет отправляет код на сервер.
3. Сервер проверяет, есть ли этот код в базе и можно ли проходить.
4. Если всё хорошо — турникет открывается, событие фиксируется в базе.
5. Администратор может посмотреть статистику и логи через веб-интерфейс.

---

##Турникет
Турникет работаетна базе контроллера WT32-ETH01 сканирует DataMatrix-код по UART с промышленного сканера и отправляет запрос на сервер через Ethernet HTTP.


### Аппаратные требования

- WT32-ETH01 (ESP32 с Ethernet)
- Сканер DataMatrix, подключённый к UART (RX/TX)
- Электромеханический замок/реле/турникет, подключённый к пину управления
- Светодиод для индикации (опционально)

---

### Установка и настройка

#### 1. Клонируйте репозиторий

```sh
git clone https://github.com/nicelight/qr_DataMatrix.git
cd qr_DataMatrix
```

#### 2. Установите [PlatformIO](https://platformio.org/) (если ещё не установлен)

- Для VSCode: установите расширение PlatformIO IDE.
- Или через pip:  
  ```sh
  pip install platformio
  ```

#### 2.1 Важные файлы

- `main_as_a_client_v0.3.cpp` — код турникета клиента
- `nastroyki.h` — все основные настройки (IP, пины и т.д.)
- `platformio.ini` — конфигурация сборки и выбора режима

---
#### 3. Настройте параметры сети

Откройте файл `src/nastroyki.h` и укажите:
- IP-адрес устройства (модуля)
- IP-адрес шлюза (роутера)
- IP-адрес сервера (для режима "Клиент")

Пример:
```cpp
#define IP_OCT1 192
#define IP_OCT2 168
#define IP_OCT3 50
#define IP_OCT4 231
#define IP_GATE 1

#define SERVER_OCT1 192
#define SERVER_OCT2 168
#define SERVER_OCT3 50
#define SERVER_OCT4 50
```

---


### Сборка и прошивка

1. Подключите WT32-ETH01 к компьютеру через USB-UART.
2. В терминале выполните:
   ```sh
   pio run -t upload
   ```
   или используйте кнопку "Upload" в PlatformIO IDE или комбинация клавиш Ctrl + Alt + U

---

#### Как работает турникет

- Сканер DataMatrix передаёт код по UART.
- Модуль извлекает числовой идентификатор из кода.
- Формируется JSON вида:
  ```json
  {
    "passIds": ["1000000000"],
    "code": "TURNIKET"
  }
  ```
- JSON отправляется POST-запросом на сервер.
- Если сервер отвечает 200 — открывается дверь на 2 секунды.
- Если ошибка или таймаут — мигает светодиод.

---

## Cерверная часть и взаимодействие 1С с урникетом

### Серверная часть (Node.js)
- Сервер находится в папке `server-nodjs` и работает на Node.js с базой данных MongoDB.
- Сервер предоставляет:
  - Веб-интерфейс для администратора (адрес: http://localhost/admin)
  - API для оборудования (турникеты, аттракционы и т.д.) по адресу http://localhost/api/callback
- Оборудование (турникеты, аттракционы) идентифицируется по IP-адресу и типу (например, "Вход", "Выход", "аттракцион").
- Сервер хранит информацию о пропусках, посещениях и оборудовании в базе данных.

### Как происходит обмен данными
1. **Клиент-турникет (ESP32, WT32-ETH01):**
   - Сканирует DataMatrix-код через сканер (UART).
   - Извлекает из кода числовой идентификатор.
   - Формирует JSON вида:
     ```json
     {
       "passIds": ["1000000000"],
       "code": "TURNIKET"
     }
     ```
   - Отправляет этот JSON POST-запросом на сервер по адресу `/api/callback`.
   - Если сервер отвечает 200 OK — открывает турникет (реле/замок) на заданное время.
   - Если ошибка — мигает светодиодом.

2. **Сервер (Node.js):**
   - Принимает запрос от оборудования.
   - Определяет тип оборудования по IP-адресу отправителя.
   - Если это турникет — проверяет, есть ли такой пропуск в базе и его статус.
   - Если всё корректно — возвращает 200 OK, иначе — ошибку с пояснением.
   - Для аттракционов — просто фиксирует посещение.
   - Для кода "INIT" — обновляет статусы пропусков в базе.

3. **Интеграция с 1С бухгалтерией:**
   - В текущей реализации прямой интеграции с 1С нет.
   - Все данные о проходах и пропусках хранятся в MongoDB.
   - Для обмена с 1С можно реализовать отдельный API или выгрузку данных из базы (например, через скрипты или REST-запросы).
   - Если требуется интеграция с 1С — это делается отдельно, в этом проекте такой функционал не реализован.

### Кратко о структуре данных
- **Оборудование (Equipment):** имя, IP, тип (Вход/Выход/аттракцион)
- **Пропуск (PassLog):** ID пропуска, статус (например, activeEntrance), время, количество использований
- **Лог аттракциона (AttractionLog):** ID оборудования, ID пропуска, время посещения


---

## Вопросы и поддержка

Если возникли вопросы — создайте issue на GitHub или напишите в группу https://t.me/smartfarm_diy с пометкой: турникеты.

---

Удачи в работе с проектом!
